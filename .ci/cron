#!/usr/bin/env bash
# Note: This script is executed from git root
set -exuo pipefail

git checkout master
git reset --hard origin/master
git pull --rebase origin master

export NIX_PATH=nixpkgs=https://github.com/NixOS/nixpkgs-channels/archive/nixos-unstable.tar.gz

export HOME=$(mktemp -d)
function finish {
    rm -rf $HOME
}
trap finish EXIT

nix-shell -p git --run 'git config --global user.name "emacs-overlay"'
nix-shell -p git --run 'git config --global user.email "emacs-overlay@nix-community"'

./update
./.ci/push
